"""
uploader/metadata_builder.py â€” YouTube ì—…ë¡œë“œ ë©”íƒ€ë°ì´í„° êµ¬ì„±

pipeline.stateë¥¼ ë°›ì•„ YouTube videos.insert API body dictë¥¼ ë°˜í™˜í•œë‹¤.
ì œëª©, ì„¤ëª…, íƒœê·¸, ì¹´í…Œê³ ë¦¬ID, ê³µê°œ ì„¤ì •ì„ í•œ/ì˜ ê°ê° êµ¬ì„±í•œë‹¤.
"""

import logging
import re
from typing import Any

logger = logging.getLogger(__name__)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¤ëª… í…œí”Œë¦¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_DESC_TEMPLATE_KO = """{summary}

ğŸ“Œ ì´ ì˜ìƒì€ AIê°€ ìë™ìœ¼ë¡œ ì œì‘í–ˆìŠµë‹ˆë‹¤.
ì›ë³¸ ì¶œì²˜: {url}

#AIì˜ìƒ #ìë™ìƒì„± #ì§€ì‹ì •ë³´"""

_DESC_TEMPLATE_EN = """{summary}

ğŸ“Œ This video was automatically created by AI.
Original source: {url}

#AIVideo #AutoGenerated #Knowledge"""

_SHORTS_TAG_KO = "#Shorts #ì‡¼ì¸ "
_SHORTS_TAG_EN = "#Shorts"

_DEFAULT_TAGS_KO = ["AIì˜ìƒ", "ìë™ìƒì„±", "ì§€ì‹", "ì •ë³´"]
_DEFAULT_TAGS_EN = ["AI", "AutoGenerated", "Knowledge", "Educational"]

# YouTube API ì œí•œê°’
_MAX_TITLE_LEN = 100
_MAX_DESC_LEN = 5000
_MAX_TAGS = 30


def build_metadata(state: dict, lang: str = "ko", is_shorts: bool = False) -> dict[str, Any]:
    """
    YouTube videos.insert body dictë¥¼ ìƒì„±í•œë‹¤.

    state:     pipeline.state
    lang:      "ko" | "en"
    is_shorts: ì‡¼ì¸  ì—¬ë¶€ (9:16 ì„¸ë¡œ ì˜ìƒ)
    ë°˜í™˜: {"snippet": {...}, "status": {...}}
    """
    import config

    title = _build_title(state, lang, is_shorts)
    description = _build_description(state, lang, is_shorts)
    tags = _build_tags(state, lang)

    metadata: dict[str, Any] = {
        "snippet": {
            "title": title[:_MAX_TITLE_LEN],
            "description": description[:_MAX_DESC_LEN],
            "tags": tags[:_MAX_TAGS],
            "categoryId": config.YOUTUBE_CATEGORY_ID,
            "defaultLanguage": "ko" if lang == "ko" else "en",
        },
        "status": {
            "privacyStatus": config.YOUTUBE_PRIVACY,
            "selfDeclaredMadeForKids": False,
        },
    }

    logger.debug(
        "[%s] ë©”íƒ€ë°ì´í„° êµ¬ì„± ì™„ë£Œ â€” ì œëª©: %s / íƒœê·¸: %dê°œ",
        lang, title[:30], len(tags),
    )
    return metadata


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë‚´ë¶€ í—¬í¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _build_title(state: dict, lang: str, is_shorts: bool) -> str:
    """
    ì œëª© êµ¬ì„±.
    ì‡¼ì¸ ëŠ” #Shorts ì ‘ë¯¸ì‚¬ë¥¼ ì¶”ê°€í•œë‹¤ (ì—†ëŠ” ê²½ìš°ì— í•œí•´).
    """
    title: str = state.get(f"youtube_title_{lang}") or "Untitled"

    if is_shorts:
        suffix = f" {_SHORTS_TAG_KO}" if lang == "ko" else f" {_SHORTS_TAG_EN}"
        if "#Shorts" not in title and "#shorts" not in title:
            max_base = _MAX_TITLE_LEN - len(suffix)
            title = title[:max_base] + suffix

    return title


def _build_description(state: dict, lang: str, is_shorts: bool) -> str:
    """
    ì„¤ëª… êµ¬ì„±.
    Hook/core ì¥ë©´ ë‚´ë ˆì´ì…˜ìœ¼ë¡œ ìš”ì•½ì„ ë§Œë“¤ê³  ì¶œì²˜ URLì„ ì¶”ê°€í•œë‹¤.
    """
    scenario = state.get(f"scenario_{lang}") or []
    url = state.get("url", "")
    summary = _extract_summary(scenario)

    template = _DESC_TEMPLATE_KO if lang == "ko" else _DESC_TEMPLATE_EN
    desc = template.format(summary=summary, url=url)

    if is_shorts:
        shorts_tag = _SHORTS_TAG_KO if lang == "ko" else _SHORTS_TAG_EN
        desc += f"\n{shorts_tag}"

    return desc


def _build_tags(state: dict, lang: str) -> list[str]:
    """
    íƒœê·¸ êµ¬ì„±.
    ì œëª© ë‹¨ì–´ + ê¸°ë³¸ íƒœê·¸ë¥¼ í•©ì‚°í•œë‹¤.
    """
    title: str = state.get(f"youtube_title_{lang}") or ""

    # ì œëª©ì—ì„œ ë‹¨ì–´ ì¶”ì¶œ (íŠ¹ìˆ˜ë¬¸ì ì œê±°, 2ì ì´ìƒë§Œ)
    words = re.sub(r"[^\w\sê°€-í£]", "", title).split()
    title_tags = [w for w in words if len(w) >= 2]

    default_tags = _DEFAULT_TAGS_KO if lang == "ko" else _DEFAULT_TAGS_EN

    # ì¤‘ë³µ ì—†ì´ í•©ì‚°
    seen: set[str] = set()
    tags: list[str] = []
    for tag in title_tags + default_tags:
        if tag not in seen:
            seen.add(tag)
            tags.append(tag)

    return tags


def _extract_summary(scenario: list) -> str:
    """
    Hook â†’ core ìˆœì„œë¡œ ìµœëŒ€ 3ê°œ ì¥ë©´ì˜ ë‚´ë ˆì´ì…˜ì„ ë½‘ì•„ ìš”ì•½ ë¬¸ì¥ì„ ë§Œë“ ë‹¤.
    """
    priority = ("hook", "core", "problem")
    lines: list[str] = []

    for stage in priority:
        for scene in scenario:
            if scene.get("stage") == stage:
                narration = scene.get("narration", "").strip()
                if narration and narration not in lines:
                    lines.append(narration)
                    break
        if len(lines) >= 3:
            break

    # priority ìŠ¤í…Œì´ì§€ì—ì„œ 3ê°œë¥¼ ëª» ì±„ìš°ë©´ ì• ì¥ë©´ìœ¼ë¡œ ë³´ì¶©
    if len(lines) < 3:
        for scene in scenario:
            narration = scene.get("narration", "").strip()
            if narration and narration not in lines:
                lines.append(narration)
            if len(lines) >= 3:
                break

    return " ".join(lines).strip()
